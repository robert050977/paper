(function(){function hash(data){var hash=0,i,chr;if(data===0){return hash;}
for(i=0;i<data.length;i++){chr=data.charCodeAt(i);hash=((hash<<5)-hash)+chr;hash|=0;}
return("0000000"+(hash>>>0).toString(16)).substr(-8);}
function sendWarning(msg,e){upScore.data.video_version=2;upScore.sendWarning("VIDEO_JS: "+msg,e);}
function trackPlayer(videoElement){try{var playerEl=videoElement.querySelector("video");if(playerEl==null||videojs==null){setTimeout(trackPlayer.bind(this,videoElement),2000);return;}
var particle=null;var infoInterval=null;var currentVideoId=null;var consumedTime=0;var lastPosition=0;var ad_impression=0;var ad_complete=0;var player=videojs.getPlayer(playerEl.id);if(player==null){sendWarning("player not found",{message:playerEl.id});return;}
var videoPlayerInfo=function(){try{if(particle==null){createParticle();}
var position=getPosition();if(position==lastPosition){return;}
lastPosition=position;var duration=Math.round(player.duration()*1000);var completion=Math.round(position/duration*100);consumedTime+=1000;var playerInfoEvent={video_position:"i:"+position,video_duration:"i:"+duration,video_completion:"i:"+completion,video_consumed_time:"i:"+consumedTime};particle.addEvent(playerInfoEvent);}catch(e){sendWarning("info failed",e);}};var getPosition=function(){try{return Math.round(player.currentTime()*1000);}catch(e){return 0;}};var createParticle=function(){try{var newVideoId=getParticleId(videoElement,player);clearInterval(infoInterval);if(currentVideoId!=newVideoId){currentVideoId=newVideoId;ad_impression=0;ad_complete=0;var p_data={particle_id:newVideoId,title:getTitle(videoElement),object_type:"video",url:player.src(),img_url:player.poster(),};var author=getAuthor(videoElement);if(author){p_data.author=author;}
consumedTime=0;particle=upScore.addParticle(p_data);}}catch(e){upScore.sendWarning("particle failed",e);}};var onPlayHandler=function(){createParticle();infoInterval=setInterval(videoPlayerInfo,1000);videoPlayerInfo();};var onPauseHandler=function(){clearInterval(infoInterval);if(player.duration()===player.currentTime()){currentVideoId=null;}else{videoPlayerInfo();}};player.on("ended",onPauseHandler);player.on("pause",onPauseHandler);player.on("resume",videoPlayerInfo);player.on("play",onPlayHandler);player.on("stop",onPauseHandler);player.on("ads-ad-started",function(){if(ad_impression!=ad_complete){ad_complete=ad_impression;particle.addEvent({ad_complete:"i:"+ad_complete});}
ad_impression++;particle.addEvent({ad_impression:"i:"+ad_impression});});player.on("adend",function(){if(ad_impression<=ad_complete){return;}
ad_complete++;particle.addEvent({ad_complete:"i:"+ad_complete});});if(!player.paused()){onPlayHandler();}}catch(error){sendWarning("tracking failed",error);}}
function getContainerElement(videoElement){var containerElementId=videoElement.id.substring(0,videoElement.id.indexOf("-vjs"));if(containerElementId!==""){return document.getElementById(containerElementId);}}
function getTitle(videoElement){var containerElement=getContainerElement(videoElement);if(containerElement){return containerElement.dataset.title;}else{return document.title;}}
function getAuthor(videoElement){var containerElement=getContainerElement(videoElement);if(containerElement){return containerElement.dataset.author;}}
function getParticleId(videoElement,player){var containerElement=getContainerElement(videoElement);if(containerElement){return containerElement.dataset.contentid;}else{return hash(player.src());}}
var getNewVideoJS=function(mutationList){for(var i=0;i<mutationList.length;i++){if(mutationList[i].addedNodes.length>0){var newChildren=mutationList[i].addedNodes;for(var j=0;j<newChildren.length;j++){if(newChildren[j].tagName==="VIDEO-JS"){trackPlayer(newChildren[j]);return;}}}}};var observer=new MutationObserver(getNewVideoJS);var observeVideos=function(){var playerContainers=Array.prototype.slice.call(document.querySelectorAll("[data-upscore-video-type=\"video-js\"]"),0);playerContainers.forEach(function(playerContainer){var videoElement=playerContainer.querySelector("video-js")
if(videoElement!==null){trackPlayer(videoElement);}
observer.observe(playerContainer,{childList:true,subtree:true});});};observeVideos();})();